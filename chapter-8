SQL> CREATE TABLE APP_AUDIT_ACTION_TYPE(
  2      ACTION_TYPE_ID NUMBER PRIMARY KEY,
  3      ACTION_TYPE_DESC VARCHAR2(30),
  4  CTL_REC_STAT VARCHAR2(1));

Table created.

SQL>
SQL>
SQL> CREATE TABLE APP_AUDIT_ENTITY (
  2      ENTITY_ID NUMBER PRIMARY KEY,
  3      ENTITY_NAME VARCHAR2(30),
  4      ENTITY_TYPE VARCHAR2(15),
  5  CTL_REC_STAT VARCHAR2(1));

Table created.

SQL>
SQL>
SQL> CREATE TABLE APP_AUDIT_ACTION(
  2      AUDIT_ACTION_ID NUMBER PRIMARY KEY,
  3      AUDIT_START_DATE DATE,
  4      AUDIT_EXPIRE_DATE DATE,
  5      CTL_INS_DTTM DATE,
  6      CTL_UPD_DTTM DATE,
  7      CTL_UPD_USER VARCHAR2(30),
  8      CTL_REC_STAT VARCHAR2(1),
  9      ACTION_TYPE_ID NUMBER,
 10      ENTITY_ID NUMBER,
 11      FOREIGN KEY(ENTITY_ID) REFERENCES APP_AUDIT_ENTITY,
 12  FOREIGN KEY(ACTION_TYPE_ID) REFERENCES APP_AUDIT_ACTION_TYPE);

Table created.

SQL>
SQL>
SQL> CREATE TABLE APP_AUDIT_DATA(
  2      AUDIT_DATA_ID NUMBER PRIMARY KEY,
  3      AUDIT_DATA VARCHAR2(4000),
  4      AUDIT_ACTION_ID NUMBER,
  5      AUD_INS_DTTM DATE,
  6      AUD_UPD_USER VARCHAR2(30),
  7      AUD_REC_STAT VARCHAR2(1),
  8  FOREIGN KEY(AUDIT_ACTION_ID) REFERENCES APP_AUDIT_ACTION);

Table created.

SQL> CREATE SEQUENCE
  2  SEQ_APP_AUDIT_DATA
  3  INCREMENT BY 1START WITH 1
  4  MINVALUE 1
  5  NOCYCLE
  6  CACHE 20
  7  NOORDER;

Sequence created.

SQL> CREATE TABLE APP_TBL1(
  2      CODE NUMBER PRIMARY KEY,
  3  DESCRIPTION VARCHAR2(20));

Table created.

SQL>
SQL> CREATE TABLE APP_TBL2(
  2      ID NUMBER PRIMARY KEY,
  3      NAME VARCHAR2(35),
  4  PHONE VARCHAR2(14));

Table created.

SQL> INSERT INTO APP_TBL1 VALUES(1, 'Description #1');

1 row created.

SQL> INSERT INTO APP_TBL1 VALUES(2, 'Description #2');

1 row created.

SQL>
SQL> INSERT INTO APP_TBL2 VALUES(100, 'Tom Jones', '123-123-1234');

1 row created.

SQL> INSERT INTO APP_TBL2 VALUES(101, 'Linda Evans', '234-234-2345');

1 row created.

SQL> INSERT INTO APP_TBL2 VALUES(102, 'Joan Collins', '345-345-3456');

1 row created.

SQL> COMMIT;

Commit complete.

SQL> INSERT INTO APP_AUDIT_ACTION_TYPE VALUES(1, 'UPDATE', 'A');

1 row created.

SQL> INSERT INTO APP_AUDIT_ACTION_TYPE VALUES(2, 'DELETE', 'A');

1 row created.

SQL> INSERT INTO APP_AUDIT_ACTION_TYPE VALUES(3, 'INSERT', 'A');

1 row created.

SQL> INSERT INTO APP_AUDIT_ENTITY VALUES(1, 'APP_TBL1', 'TABLE', 'A');

1 row created.

SQL> INSERT INTO APP_AUDIT_ENTITY VALUES(2, 'APP_TBL2', 'TABLE', 'A');

1 row created.

SQL> INSERT INTO APP_AUDIT_ENTITY VALUES(3, USER, 'USER', 'A');

1 row created.

SQL> INSERT INTO APP_AUDIT_ACTION VALUES (
  2      1, SYSDATE, SYSDATE + 30, SYSDATE, SYSDATE, USER, 'A',
  3      1, 1
  4  );

1 row created.

SQL> INSERT INTO APP_AUDIT_ACTION VALUES (
  2      2, SYSDATE, SYSDATE + 30, SYSDATE, SYSDATE, USER, 'A',
  3      2, 1
  4  );

1 row created.

SQL> INSERT INTO APP_AUDIT_ACTION VALUES (
  2      3, SYSDATE, SYSDATE + 30, SYSDATE, SYSDATE, USER, 'A',
  3      3, 1
  4  );

1 row created.

SQL> INSERT INTO APP_AUDIT_ACTION VALUES (
  2      4, SYSDATE, SYSDATE + 30, SYSDATE, SYSDATE, USER, 'A',
  3      1, 2
  4  );

1 row created.

SQL> INSERT INTO APP_AUDIT_ACTION VALUES (
  2      5, SYSDATE, SYSDATE + 30, SYSDATE, SYSDATE, USER, 'A',
  3      2, 2
  4  );

1 row created.

SQL> INSERT INTO APP_AUDIT_ACTION VALUES (
  2      6, SYSDATE, SYSDATE + 30, SYSDATE, SYSDATE, USER, 'A',
  3      3, 2
  4  );

1 row created.

SQL> INSERT INTO APP_AUDIT_ACTION VALUES (
  2      7, SYSDATE, SYSDATE + 30, SYSDATE, SYSDATE, USER, 'A',
  3      1, 3
  4  );

1 row created.

SQL>
SQL> INSERT INTO APP_AUDIT_ACTION VALUES (
  2      8, SYSDATE, SYSDATE + 30, SYSDATE, SYSDATE, USER, 'A',
  3      2, 3
  4  );

1 row created.

SQL>
SQL> INSERT INTO APP_AUDIT_ACTION VALUES (
  2      9, SYSDATE, SYSDATE + 30, SYSDATE, SYSDATE, USER, 'A',
  3      3, 3
  4  );

1 row created.

SQL>
SQL> COMMIT;

Commit complete.

SQL> CREATE OR REPLACE PACKAGE PKG_APP_AUDIT IS
  2      PROCEDURE LOG_OPERATION(
  3          P_TABLE_NAME VARCHAR2,
  4          P_OPERATION VARCHAR2,
  5          P_OLD_DATA VARCHAR2 DEFAULT NULL,
  6          P_NEW_DATA VARCHAR2 DEFAULT NULL);
  7  END;
  8  /

Package created.

SQL> CREATE OR REPLACE PACKAGE BODY PKG_APP_AUDIT IS
  2      PROCEDURE LOG_OPERATION(
  3          P_TABLE_NAME VARCHAR2,
  4          P_OPERATION VARCHAR2,
  5          P_OLD_DATA VARCHAR2 DEFAULT NULL,
  6          P_NEW_DATA VARCHAR2 DEFAULT NULL
  7      ) IS
  8          V_AUDIT_ACTION_ID NUMBER;
  9          V_AUDIT_DATA VARCHAR2(4000);
 10      BEGIN
 11          -- First try to find a specific audit action for this table and operation
 12          BEGIN
 13              SELECT A.AUDIT_ACTION_ID INTO V_AUDIT_ACTION_ID
 14              FROM APP_AUDIT_ACTION A, APP_AUDIT_ENTITY E, APP_AUDIT_ACTION_TYPE T
 15              WHERE A.ENTITY_ID = E.ENTITY_ID
 16              AND A.ACTION_TYPE_ID = T.ACTION_TYPE_ID
 17              AND E.ENTITY_NAME = P_TABLE_NAME
 18              AND E.ENTITY_TYPE = 'TABLE'
 19              AND T.ACTION_TYPE_DESC = UPPER(P_OPERATION)
 20              AND SYSDATE BETWEEN A.AUDIT_START_DATE AND A.AUDIT_EXPIRE_DATE
 21              AND ROWNUM = 1;
 22          EXCEPTION
 23              WHEN NO_DATA_FOUND THEN
 24                  -- If not found, try to find a general audit action for the user
 25                  BEGIN
 26                      SELECT A.AUDIT_ACTION_ID INTO V_AUDIT_ACTION_ID
 27                      FROM APP_AUDIT_ACTION A, APP_AUDIT_ENTITY E, APP_AUDIT_ACTION_TYPE T
 28                      WHERE A.ENTITY_ID = E.ENTITY_ID
 29                      AND A.ACTION_TYPE_ID = T.ACTION_TYPE_ID
 30                      AND E.ENTITY_NAME = USER
 31                      AND E.ENTITY_TYPE = 'USER'
 32                      AND T.ACTION_TYPE_DESC = UPPER(P_OPERATION)
 33                      AND SYSDATE BETWEEN A.AUDIT_START_DATE AND A.AUDIT_EXPIRE_DATE
 34                      AND ROWNUM = 1;
 35                  EXCEPTION
 36                      WHEN NO_DATA_FOUND THEN
 37                          RETURN; -- No audit configuration found
 38                  END;
 39          END;
 40
 41          -- Prepare audit data
 42          V_AUDIT_DATA := P_OPERATION || ' on ' || P_TABLE_NAME;
 43          IF P_OLD_DATA IS NOT NULL THEN
 44              V_AUDIT_DATA := V_AUDIT_DATA || ' | Old: ' || P_OLD_DATA;
 45          END IF;
 46          IF P_NEW_DATA IS NOT NULL THEN
 47              V_AUDIT_DATA := V_AUDIT_DATA || ' | New: ' || P_NEW_DATA;
 48          END IF;
 49
 50          -- Insert audit record
 51          INSERT INTO APP_AUDIT_DATA(
 52              AUDIT_DATA_ID, AUDIT_DATA, AUDIT_ACTION_ID,
 53              AUD_INS_DTTM, AUD_UPD_USER, AUD_REC_STAT
 54          ) VALUES (
 55              SEQ_APP_AUDIT_DATA.NEXTVAL, V_AUDIT_DATA, V_AUDIT_ACTION_ID,
 56              SYSDATE, USER, 'A'
 57          );
 58  END;
 59  END;
 60  /

Package body created.

SQL> CREATE OR REPLACE TRIGGER TRG_APP_TBL1_AUDIT
  2  BEFORE INSERT OR UPDATE OR DELETE ON APP_TBL1 FOR EACH ROW DECLARE
  3      V_OPERATION VARCHAR2(10);
  4      V_OLD_DATA VARCHAR2(4000);
  5      V_NEW_DATA VARCHAR2(4000);BEGIN
  6      IF INSERTING THEN
  7          V_OPERATION := 'INSERT';
  8          V_NEW_DATA := 'CODE=' || :NEW.CODE || ',DESC=' || :NEW.DESCRIPTION;
  9          PKG_APP_AUDIT.LOG_OPERATION('APP_TBL1', V_OPERATION, NULL, V_NEW_DATA);
 10      ELSIF UPDATING THEN
 11          V_OPERATION := 'UPDATE';
 12          V_OLD_DATA := 'CODE=' || :OLD.CODE || ',DESC=' || :OLD.DESCRIPTION;
 13          V_NEW_DATA := 'CODE=' || :NEW.CODE || ',DESC=' || :NEW.DESCRIPTION;
 14          PKG_APP_AUDIT.LOG_OPERATION('APP_TBL1', V_OPERATION, V_OLD_DATA, V_NEW_DATA);
 15      ELSIF DELETING THEN
 16          V_OPERATION := 'DELETE';
 17          V_OLD_DATA := 'CODE=' || :OLD.CODE || ',DESC=' || :OLD.DESCRIPTION;
 18          PKG_APP_AUDIT.LOG_OPERATION('APP_TBL1', V_OPERATION, V_OLD_DATA, NULL);
 19  END IF;
 20  END;
 21  /

Trigger created.

SQL>
SQL>
SQL> CREATE OR REPLACE TRIGGER TRG_APP_TBL2_AUDIT
  2  BEFORE INSERT OR UPDATE OR DELETE ON APP_TBL2 FOR EACH ROW DECLARE
  3      V_OPERATION VARCHAR2(10);
  4      V_OLD_DATA VARCHAR2(4000);
  5      V_NEW_DATA VARCHAR2(4000);BEGIN
  6      IF INSERTING THEN
  7          V_OPERATION := 'INSERT';
  8          V_NEW_DATA := 'ID=' || :NEW.ID || ',NAME=' || :NEW.NAME || ',PHONE=' || :NEW.PHONE;
  9          PKG_APP_AUDIT.LOG_OPERATION('APP_TBL2', V_OPERATION, NULL, V_NEW_DATA);
 10      ELSIF UPDATING THEN
 11          V_OPERATION := 'UPDATE';
 12          V_OLD_DATA := 'ID=' || :OLD.ID || ',NAME=' || :OLD.NAME || ',PHONE=' || :OLD.PHONE;
 13          V_NEW_DATA := 'ID=' || :NEW.ID || ',NAME=' || :NEW.NAME || ',PHONE=' || :NEW.PHONE;
 14          PKG_APP_AUDIT.LOG_OPERATION('APP_TBL2', V_OPERATION, V_OLD_DATA, V_NEW_DATA);
 15      ELSIF DELETING THEN
 16          V_OPERATION := 'DELETE';
 17          V_OLD_DATA := 'ID=' || :OLD.ID || ',NAME=' || :OLD.NAME || ',PHONE=' || :OLD.PHONE;
 18          PKG_APP_AUDIT.LOG_OPERATION('APP_TBL2', V_OPERATION, V_OLD_DATA, NULL);
 19  END IF;
 20  END;
 21  /

Trigger created.

SQL> INSERT INTO APP_TBL1 VALUES (4, 'Description #4');

1 row created.

SQL>
SQL> INSERT INTO APP_TBL2 VALUES (104, 'Updated Person', '666-666-6666');

1 row created.

SQL> SET LINESIZE 200
SQL> SET PAGESIZE 100
SQL> COLUMN OPERATION FORMAT A50
SQL> COLUMN ON_ENTITY FORMAT A15
SQL> COLUMN ACTION_TYPE FORMAT A10
SQL>
SQL> SELECT
  2      D.AUDIT_DATA_ID,
  3      D.AUDIT_DATA AS OPERATION,
  4      TO_CHAR(D.AUD_INS_DTTM, 'DD-MON-YYYY HH24:MI:SS') AS TIMESTAMP,
  5      D.AUD_UPD_USER AS PERFORMED_BY,
  6      E.ENTITY_NAME AS ON_ENTITY,
  7  T.ACTION_TYPE_DESC AS ACTION_TYPE
  8  FROM
  9      APP_AUDIT_DATA D,
 10      APP_AUDIT_ACTION A,
 11      APP_AUDIT_ENTITY E,
 12  APP_AUDIT_ACTION_TYPE T
 13  WHERE
 14      D.AUDIT_ACTION_ID = A.AUDIT_ACTION_ID
 15      AND A.ENTITY_ID = E.ENTITY_ID
 16  AND A.ACTION_TYPE_ID = T.ACTION_TYPE_ID
 17  ORDER BY
 18      D.AUDIT_DATA_ID;

AUDIT_DATA_ID OPERATION                                          TIMESTAMP       PERFORMED_BY                    ON_ENTITY       ACTION_TYP
------------- -------------------------------------------------- -------------------- ------------------------------ --------------- ----------
            2 INSERT on APP_TBL1 | New: CODE=4,DESC=Description  04-APR-2025 23:10:20 SCOTT                      APP_TBL1        INSERT
              #4

            3 INSERT on APP_TBL2 | New: ID=104,NAME=Updated Pers 04-APR-2025 23:10:20 SCOTT                      APP_TBL2        INSERT
              on,PHONE=666-666-6666


SQL> -- Test UPDATE
SQL> UPDATE APP_TBL2 SET PHONE = '999-999-9999' WHERE ID = 100;

1 row updated.

SQL> SELECT
  2      D.AUDIT_DATA_ID,
  3      D.AUDIT_DATA AS OPERATION,
  4      TO_CHAR(D.AUD_INS_DTTM, 'DD-MON-YYYY HH24:MI:SS') AS TIMESTAMP,
  5      D.AUD_UPD_USER AS PERFORMED_BY,
  6      E.ENTITY_NAME AS ON_ENTITY,
  7  T.ACTION_TYPE_DESC AS ACTION_TYPE
  8  FROM
  9      APP_AUDIT_DATA D,
 10      APP_AUDIT_ACTION A,
 11      APP_AUDIT_ENTITY E,
 12  APP_AUDIT_ACTION_TYPE T
 13  WHERE
 14      D.AUDIT_ACTION_ID = A.AUDIT_ACTION_ID
 15      AND A.ENTITY_ID = E.ENTITY_ID
 16  AND A.ACTION_TYPE_ID = T.ACTION_TYPE_ID
 17  ORDER BY
 18      D.AUDIT_DATA_ID;

AUDIT_DATA_ID OPERATION                                          TIMESTAMP       PERFORMED_BY                    ON_ENTITY       ACTION_TYP
------------- -------------------------------------------------- -------------------- ------------------------------ --------------- ----------
            2 INSERT on APP_TBL1 | New: CODE=4,DESC=Description  04-APR-2025 23:10:20 SCOTT                      APP_TBL1        INSERT
              #4

            3 INSERT on APP_TBL2 | New: ID=104,NAME=Updated Pers 04-APR-2025 23:10:20 SCOTT                      APP_TBL2        INSERT
              on,PHONE=666-666-6666

            4 UPDATE on APP_TBL2 | Old: ID=100,NAME=Tom Jones,PH 04-APR-2025 23:11:01 SCOTT                      APP_TBL2        UPDATE
              ONE=123-123-1234 | New: ID=100,NAME=Tom Jones,PHON
              E=999-999-9999


SQL> DELETE FROM APP_TBL1 WHERE CODE = 2;

1 row deleted.

SQL> DELETE FROM APP_TBL2 WHERE ID = 101;

1 row deleted.

SQL> COMMIT;

Commit complete.

SQL>
SQL> SELECT
  2      D.AUDIT_DATA_ID,
  3      D.AUDIT_DATA AS OPERATION,
  4      TO_CHAR(D.AUD_INS_DTTM, 'DD-MON-YYYY HH24:MI:SS') AS TIMESTAMP,
  5      D.AUD_UPD_USER AS PERFORMED_BY,
  6      E.ENTITY_NAME AS ON_ENTITY,
  7  T.ACTION_TYPE_DESC AS ACTION_TYPE
  8  FROM
  9      APP_AUDIT_DATA D,
 10      APP_AUDIT_ACTION A,
 11      APP_AUDIT_ENTITY E,
 12  APP_AUDIT_ACTION_TYPE T
 13  WHERE
 14      D.AUDIT_ACTION_ID = A.AUDIT_ACTION_ID
 15      AND A.ENTITY_ID = E.ENTITY_ID
 16  AND A.ACTION_TYPE_ID = T.ACTION_TYPE_ID
 17  ORDER BY
 18      D.AUDIT_DATA_ID;

AUDIT_DATA_ID OPERATION                                          TIMESTAMP       PERFORMED_BY                    ON_ENTITY       ACTION_TYP
------------- -------------------------------------------------- -------------------- ------------------------------ --------------- ----------
            2 INSERT on APP_TBL1 | New: CODE=4,DESC=Description  04-APR-2025 23:10:20 SCOTT                      APP_TBL1        INSERT
              #4

            3 INSERT on APP_TBL2 | New: ID=104,NAME=Updated Pers 04-APR-2025 23:10:20 SCOTT                      APP_TBL2        INSERT
              on,PHONE=666-666-6666

            4 UPDATE on APP_TBL2 | Old: ID=100,NAME=Tom Jones,PH 04-APR-2025 23:11:01 SCOTT                      APP_TBL2        UPDATE
              ONE=123-123-1234 | New: ID=100,NAME=Tom Jones,PHON
              E=999-999-9999

            5 DELETE on APP_TBL1 | Old: CODE=2,DESC=Description  04-APR-2025 23:11:35 SCOTT                      APP_TBL1        DELETE
              #2

            6 DELETE on APP_TBL2 | Old: ID=101,NAME=Linda Evans, 04-APR-2025 23:11:35 SCOTT                      APP_TBL2        DELETE
              PHONE=234-234-2345


SQL>







